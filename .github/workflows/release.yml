name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 16.5.7). Used for manual runs."
        required: false
        default: ""
      publish:
        description: "Publish wheels to PyPI"
        required: false
        default: "false"
      build_assets:
        description: "Package + upload GitHub Release assets"
        required: false
        default: "false"

jobs:
  wheels:
    name: wheels (${{ matrix.os }} ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            arch: x86_64
            cibw_archs: x86_64
          - os: ubuntu-latest
            arch: x86_64
            cibw_archs: x86_64
          - os: ubuntu-latest
            arch: aarch64
            cibw_archs: aarch64
          - os: macos-13
            arch: x86_64
            cibw_archs: x86_64
          - os: macos-14
            arch: arm64
            cibw_archs: arm64
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU (Linux aarch64)
        if: ${{ matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64' }}
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Resolve version
        id: vars
        shell: bash
        env:
          MANUAL_VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          if [[ -n "${MANUAL_VERSION}" ]]; then
            echo "version=${MANUAL_VERSION}" >> "$GITHUB_OUTPUT"
          else
            ref="${GITHUB_REF_NAME:-v0.0.0}"
            echo "version=${ref#v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build wheels (miru-core + miru-tools)
        env:
          MIRU_VERSION: ${{ steps.vars.outputs.version }}
          CIBW_ENVIRONMENT: MIRU_VERSION=${{ steps.vars.outputs.version }}
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          # miru-core is abi3 (cp39+), so build with the lowest supported CPython only.
          CIBW_BUILD: "cp39-*"
          CIBW_SKIP: "pp*"
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          python -m pip install "cibuildwheel==2.19.2"

          python -m cibuildwheel subprojects/miru-python --output-dir dist/wheels
          python -m pip wheel -w dist/wheels --no-deps subprojects/miru-tools

      - name: Smoke test (install wheels + basic CLI)
        shell: bash
        run: |
          set -euo pipefail
          python -m venv venv
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            py="venv/Scripts/python.exe"
            miru="venv/Scripts/miru.exe"
          else
            py="venv/bin/python"
            miru="venv/bin/miru"
          fi
          "$py" -m pip install -U pip
          "$py" -m pip install dist/wheels/miru_core-*.whl dist/wheels/miru_tools-*.whl

          "$py" -c "import miru; print(miru.__version__)"
          "$miru" --AUTO
          "$miru" --help > /dev/null
          "$miru" --EN
          "$miru" --help > /dev/null

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/wheels/*.whl

  publish_pypi:
    name: publish (PyPI)
    needs: wheels
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag' || inputs.publish == 'true'
    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/wheels
          pattern: wheels-*
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: dist/wheels

  release_assets_android:
    name: release assets (Android)
    needs: wheels
    runs-on: ubuntu-latest
    if: (github.ref_type == 'tag') && (inputs.build_assets == 'true')
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Resolve version
        id: vars
        shell: bash
        env:
          MANUAL_VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          if [[ -n "${MANUAL_VERSION}" ]]; then
            echo "version=${MANUAL_VERSION}" >> "$GITHUB_OUTPUT"
          else
            ref="${GITHUB_REF_NAME:-v0.0.0}"
            echo "version=${ref#v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Package assets + manifest
        shell: bash
        run: |
          set -euo pipefail
          python tools/release/build_assets.py --version "${{ steps.vars.outputs.version }}"

      - name: Upload GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/release/v${{ steps.vars.outputs.version }}/*
